<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>Cronjobs</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="highlight/solarized-light.css" /><script type="text/javascript" src="highlight/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a> with <a href="https://github.com/xsc/codox-theme-rdash">RDash UI</a> theme</h2><h1><a href="index.html"><span class="project-title"><span class="project-name"></span> <span class="project-version"></span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Topics</span></h3><ul><li class="depth-1 "><a href="cicd.html"><div class="inner"><span>Testing and Deployment</span></div></a></li><li class="depth-1 "><a href="components.html"><div class="inner"><span>Components (We Call Them Bricks)</span></div></a></li><li class="depth-1  current"><a href="cronjobs.html"><div class="inner"><span>Cronjobs</span></div></a></li><li class="depth-1 "><a href="messages.html"><div class="inner"><span>Messages</span></div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>gigalith</span></div></div></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>athena</span></div></div></li><li class="depth-3"><a href="gigalith.athena.interface.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>interface</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>database</span></div></div></li><li class="depth-3"><a href="gigalith.database.interface.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>interface</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>environ</span></div></div></li><li class="depth-3"><a href="gigalith.environ.interface.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>interface</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>hint</span></div></div></li><li class="depth-3"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>interface</span></div></div></li><li class="depth-4 branch"><a href="gigalith.hint.interface.api.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>api</span></div></a></li><li class="depth-4 branch"><a href="gigalith.hint.interface.conversion.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>conversion</span></div></a></li><li class="depth-4 branch"><a href="gigalith.hint.interface.matching.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>matching</span></div></a></li><li class="depth-4"><a href="gigalith.hint.interface.postgres.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>postgres</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree" style="top: -176px;"><span class="top" style="height: 185px;"></span><span class="bottom"></span></span><span>iterable</span></div></div></li><li class="depth-3"><a href="gigalith.iterable.interface.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>interface</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>jetty</span></div></div></li><li class="depth-3"><a href="gigalith.jetty.interface.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>interface</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>log</span></div></div></li><li class="depth-3"><a href="gigalith.log.interface.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>interface</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>malli</span></div></div></li><li class="depth-3"><a href="gigalith.malli.interface.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>interface</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>metrics</span></div></div></li><li class="depth-3"><a href="gigalith.metrics.interface.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>interface</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>patient</span></div></div></li><li class="depth-3"><a href="gigalith.patient.interface.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>interface</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>provider</span></div></div></li><li class="depth-3"><a href="gigalith.provider.interface.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>interface</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>sponsor</span></div></div></li><li class="depth-3"><a href="gigalith.sponsor.interface.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>interface</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>sqs-consumer</span></div></div></li><li class="depth-3"><a href="gigalith.sqs-consumer.interface.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>interface</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>sqs</span></div></div></li><li class="depth-3"><a href="gigalith.sqs.interface.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>interface</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>utils</span></div></div></li><li class="depth-3"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>interface</span></div></div></li><li class="depth-4 branch"><a href="gigalith.utils.interface.edn.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>edn</span></div></a></li><li class="depth-4 branch"><a href="gigalith.utils.interface.http.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>http</span></div></a></li><li class="depth-4 branch"><a href="gigalith.utils.interface.hugsql.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>hugsql</span></div></a></li><li class="depth-4 branch"><a href="gigalith.utils.interface.json.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>json</span></div></a></li><li class="depth-4 branch"><a href="gigalith.utils.interface.selmer.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>selmer</span></div></a></li><li class="depth-4"><a href="gigalith.utils.interface.time.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>time</span></div></a></li></ul></div><div class="document" id="content"><div class="doc"><div class="markdown"><h1><a href="#cronjobs" id="cronjobs"></a>Cronjobs</h1>
<p>Cronjobs live in the <code>cli</code> base and are run using the <code>toybox</code> project. Jobs live in <code>cli/jobs</code> and should be namespaced if appropriate (i.e. <code>iterable/update_users</code>). Jobs need to be defined in the appropriate job edn files (<code>stage-jobs.edn</code> and <code>prod-jobs.edn</code>) to be scheduled to run in the cluster.</p>
<h2><a href="#writing-a-new-job" id="writing-a-new-job"></a>Writing a New Job</h2>
<p>To start, create your job’s namespace under <code>cli/jobs</code>. Arguments are initially all strings. Use <code>clojure.tools.cli/parse-opts</code> if you need more stringent argument handling and conversion. The arguments should be defined in your job’s namespace.</p>
<pre><code>(ns gigalith.cli.jobs.example)

(def cli-options
  [["-x" "--example gigalith" "example"]])
</code></pre>
<p>Jobs should use environment variables and <code>mount</code> for managing dependency initialization.</p>
<pre><code>(ns gigalith.cli.jobs.example
  (:require [mount.core :as mount]
            [gigalith.database.interface :as database]
            [gigalith.environ.interface :as environ]
            [gigalith.log.interface :as log]))

...

(def env-spec
  [:map
   [:PSQL_HOST :string]
   [:PSQL_PORT :int]
   [:PSQL_DB :string]
   [:PSQL_USER :string]
   [:PSQL_PASSWORD :string]
   [:PSQL_SSL {:optional true} [:boolean {:default false}]]])
   
(declare env)
(declare logging)
(declare postgres-db)

(mount/defstate env
  :start (environ/init! env-spec))

(mount/defstate logging
  :start (log/init!))
  
(mount/defstate postgres-db
  :start (database/start! {:host     (:PSQL_HOST env)
                           :port     (:PSQL_PORT env)
                           :db       (:PSQL_DB env)
                           :user     (:PSQL_USER env)
                           :password (:PSQL_PASSWORD env)
                           :ssl      (:PSQL_SSL env)})
  :stop (database/stop! db))
</code></pre>
<p>The main entry to a job should be a function named <code>run</code>. That function will be responsible for starting the mounted states, logging job-specific information, performing the functions of the job, and finally stopping the mounted states. Additionally, if the job requires a “bookmark”, the job is responsible for retrieving and setting the “bookmark”.</p>
<pre><code>(ns gigalith.cli.jobs.example
  (:require [mount.core :as mount]
            [gigalith.log.interface :as log]
            [gigalith.utils.interface.time :as time]
            [gigalith.cli.jobs :as jobs]))

...

(defn run
  [{:keys [example]}]
  (mount/start)
  (log/with-context {:example example}
    (let [bookmark (jobs/get-last-run postgres-db "example")
          now      (time/local-date-time-now)]
      (log/info "Doing the thing")
      (do-the-thing bookmark)
      (log/info "Did the thing")
      (jobs/set-last-run postgres-db "example" now)))
  (mount/stop))
</code></pre>
<p>With the job’s <code>run</code> fn completed, the job must finally be registered with the <code>cli.jobs/run</code> multimethod. In the <code>cli.core</code> namespace, declare a <code>defmethod</code> for <code>cli.jobs/run</code> with the dispatch being a keyword of the job name (i.e. <code>:iterable/update-users</code>).</p>
<pre><code>(ns gigalith.cli.core
  (:require [clojure.tools.cli :refer [parse-opts]]
            [gigalith.cli.jobs :as jobs]))
            [gigalith.cli.jobs.example :as example]))

...
  
(defmethod jobs/run :example
  [[_ &amp; args]]
  (let [{:keys [opts]} (parse-opts args example/cli-opts)]
    (example/run opts)))

...
</code></pre>
<p>Finally, add the job to the job definition files (<code>stage-jobs.edn</code> and/or <code>prod-jobs.edn</code>).</p>
<pre><code>{:tenant-name "duploservices-stage01"
 :cronjobs    [...
               {:name     "example"
                :schedule "15 * * * *"
                :command  "example -x this-is-an-example"
                :secrets  ["app-postgres"]}]}
</code></pre>
<h2><a href="#deploying-jobs" id="deploying-jobs"></a>Deploying Jobs</h2>
<p>Jobs are deployed in the <code>deploy-toybox</code> step of the stage and production deploys. Jobs are built from the job.edn files. The <code>build-cronjobs</code> build.clj function is responsible for creating the job definition as well as the <code>kustomization.yaml</code> file that sets the image during apply. To build the yaml files locally:</p>
<p><code>clj -T:build build-cronjobs :file jobs.edn</code></p>
<p>Jobs are output to <code>./cronjobs</code>.</p>
<p>During deploys the generated job files are avaliable as artifacts.</p>
</div></div></div></body></html>